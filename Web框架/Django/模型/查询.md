---
title: 查询
description: 
published: true
date: 2021-02-25T12:51:39.911Z
tags: django
editor: markdown
dateCreated: 2021-02-24T11:01:54.344Z
---

# 查询对象

> [QuerySet API 参考](https://docs.djangoproject.com/zh-hans/3.1/ref/models/querysets/#)
{.is-info}

从数据库检索对象，要通过模型类的 Manager 构建一个 QuerySet。一个 QuerySet 代表来自数据库中对象的一个集合。它可以有 0 个，1 个或者多个。

每个模型至少有一个 Manager，默认名称是 objects。

```python
from django.db import models

# Create your models here.
# 准备书籍列表信息的模型类
class BookInfo(models.Model):
    # 创建字段，字段类型...
    name = models.CharField(max_length=20, verbose_name='名称')
    pub_date = models.DateField(verbose_name='发布日期',null=True)
    readcount = models.IntegerField(default=0, verbose_name='阅读量')
    commentcount = models.IntegerField(default=0, verbose_name='评论量')
    is_delete = models.BooleanField(default=False, verbose_name='逻辑删除')

    class Meta:
        db_table = 'bookinfo'  # 指明数据库表名
        verbose_name = '图书'  # 在admin站点中显示的名称

    def __str__(self):
        """定义每个数据对象的显示信息"""
        return self.name

# 准备人物列表信息的模型类
class PeopleInfo(models.Model):
    GENDER_CHOICES = (
        (0, 'male'),
        (1, 'female')
    )
    name = models.CharField(max_length=20, verbose_name='名称')
    gender = models.SmallIntegerField(choices=GENDER_CHOICES, default=0, verbose_name='性别')
    description = models.CharField(max_length=200, null=True, verbose_name='描述信息')
    book = models.ForeignKey(BookInfo, on_delete=models.CASCADE, verbose_name='图书')  # 外键
    is_delete = models.BooleanField(default=False, verbose_name='逻辑删除')

    class Meta:
        db_table = 'peopleinfo'
        verbose_name = '人物信息'

    def __str__(self):
        return self.name
```

```sql
insert into bookinfo(name, pub_date, readcount,commentcount, is_delete) values
('射雕英雄传', '1980-5-1', 12, 34, 0),
('天龙八部', '1986-7-24', 36, 40, 0),
('笑傲江湖', '1995-12-24', 20, 80, 0),
('雪山飞狐', '1987-11-11', 58, 24, 0);

insert into peopleinfo(name, gender, book_id, description, is_delete)  values
    ('郭靖', 1, 1, '降龙十八掌', 0),
    ('黄蓉', 0, 1, '打狗棍法', 0),
    ('黄药师', 1, 1, '弹指神通', 0),
    ('欧阳锋', 1, 1, '蛤蟆功', 0),
    ('梅超风', 0, 1, '九阴白骨爪', 0),
    ('乔峰', 1, 2, '降龙十八掌', 0),
    ('段誉', 1, 2, '六脉神剑', 0),
    ('虚竹', 1, 2, '天山六阳掌', 0),
    ('王语嫣', 0, 2, '神仙姐姐', 0),
    ('令狐冲', 1, 3, '独孤九剑', 0),
    ('任盈盈', 0, 3, '弹琴', 0),
    ('岳不群', 1, 3, '华山剑法', 0),
    ('东方不败', 0, 3, '葵花宝典', 0),
    ('胡斐', 1, 4, '胡家刀法', 0),
    ('苗若兰', 0, 4, '黄衣', 0),
    ('程灵素', 0, 4, '医术', 0),
    ('袁紫衣', 0, 4, '六合拳', 0);
```

# 返回新 QuerySet 的方法

## filter()

根据查询条件，返回满足条件参数的 QuerySet。多个参数通过底层 SQL 语句中的 AND 连接。

```python
>>> BookInfo.objects.filter(name='天龙八部',id=2)
<QuerySet [<BookInfo: 天龙八部>]>
```

## exclude()

根据查询条件，返回不满足条件参数的 QuerySet。多个参数通过底层 SQL 语句中的 AND 连接，整个过程用 NOT() 括起来。

- 多个条件

```python
>>> BookInfo.objects.exclude(name='天龙八部',id=2)
<QuerySet [<BookInfo: 射雕英雄传>, <BookInfo: 笑傲江湖>, <BookInfo: 雪山飞狐>]>
```

用 SQL 术语：

```sql
SELECT ... WHERE NOT (name='天龙八部' AND id=2);
```

- 多次 exclude

```python
>>> BookInfo.objects.exclude(name='天龙八部').exclude(id=3)
<QuerySet [<BookInfo: 射雕英雄传>, <BookInfo: 雪山飞狐>]>
```

用 SQL 术语：

```sql
SELECT ... WHERE NOT name='天龙八部' AND NOT id=3;
```

## annotate()

用所提供的[查询表达式](https://docs.djangoproject.com/zh-hans/3.1/ref/models/expressions/)列表对 QuerySet 中的每个对象进行注解

```python
>>> from django.db.models import Count
>>> BookInfo.objects.annotate(Count('id'))
<QuerySet [<BookInfo: 射雕英雄传>, <BookInfo: 天龙八部>, <BookInfo: 笑傲江湖>, <BookInfo: 雪山飞狐>]>
```

## order_by()

对查询结果排序，默认情况下，返回的结果是按照模型 Meta 中的 ordering 选项给出的排序元组排序的

```python
>>> BookInfo.objects.order_by() # 默认排序
<QuerySet [<BookInfo: 射雕英雄传>, <BookInfo: 天龙八部>, <BookInfo: 笑傲江湖>, <BookInfo: 雪山飞狐>]>
>>> BookInfo.objects.order_by('-id') # id 倒叙排序
<QuerySet [<BookInfo: 雪山飞狐>, <BookInfo: 笑傲江湖>, <BookInfo: 天龙八部>, <BookInfo: 射雕英雄传>]>
>>> BookInfo.objects.order_by('?') # 随机排序
<QuerySet [<BookInfo: 雪山飞狐>, <BookInfo: 天龙八部>, <BookInfo: 射雕英雄传>, <BookInfo: 笑傲江湖>]>
```

## reverse()

使用 reverse() 方法来反向返回查询集元素的顺序

```python
>>> BookInfo.objects.reverse()
<QuerySet [<BookInfo: 射雕英雄传>, <BookInfo: 天龙八部>, <BookInfo: 雪山飞狐>, <BookInfo: 笑傲江湖>]>
>>> BookInfo.objects.reverse().reverse()
<QuerySet [<BookInfo: 笑傲江湖>, <BookInfo: 雪山飞狐>, <BookInfo: 天龙八部>, <BookInfo: 射雕英雄传>]>
```

## distinct()

在其 SQL 查询中使用 SELECT DISTINCT。这将消除查询结果中的重复记录。默认情况下，QuerySet 不会消除重复的记录

```python
>>> BookInfo.objects.distinct()
```

## values()

返回一个 QuerySet，用于迭代时返回字典，而不是对象实例。每一个字典都代表一个对象，键与模型对象的属性名相对应。

```python
>>> BookInfo.objects.values()
<QuerySet [{'id': 3, 'name': '笑傲江湖', 'pub_date': datetime.date(1995, 12, 24), 'readcount': 20, 'commentcount': 80, 'is_delete': F}, {'id': 4, 'name': '雪山飞狐', 'pub_date': datetime.date(1987, 11, 11), 'readcount': 58, 'commentcount': 34, 'is_delete': False}, {: 2, 'name': '天龙八部', 'pub_date': datetime.date(1986, 7, 24), 'readcount': 36, 'commentcount': 40, 'is_delete': False}, {'id': 1, e': '射雕英雄传', 'pub_date': datetime.date(1980, 5, 1), 'readcount': 12, 'commentcount': 34, 'is_delete': False}]>
>>> 
>>> BookInfo.objects.values('id','name') # 限制 id name
<QuerySet [{'id': 3, 'name': '笑傲江湖'}, {'id': 4, 'name': '雪山飞狐'}, {'id': 2, 'name': '天龙八部'}, {'id': 1, 'name': '射雕英雄传'}]>
>>> 
```

## values_list()

与 values() 类似，只是在迭代时不返回字典，而是返回元组

```python
>>> BookInfo.objects.values_list('id','name')
<QuerySet [(3, '笑傲江湖'), (4, '雪山飞狐'), (2, '天龙八部'), (1, '射雕英雄传')]>
>>>
>>> BookInfo.objects.values_list('id')
<QuerySet [(3,), (4,), (2,), (1,)]>
>>> BookInfo.objects.values_list('id',flat=True) # flat=True 返回单个元素
<QuerySet [3, 4, 2, 1]>
>>>
>>> BookInfo.objects.values_list('name',flat=True)
<QuerySet ['笑傲江湖', '雪山飞狐', '天龙八部', '射雕英雄传']>
>>> BookInfo.objects.values_list('name',flat=True).get(id=2)
'天龙八部'
```

## dates()

值是一个 datetime.date 对象的列表

```python
>>> BookInfo.objects.filter(id__lt=3).dates('pub_date','year')  # 年
<QuerySet [datetime.date(1980, 1, 1), datetime.date(1986, 1, 1)]>
>>> BookInfo.objects.filter(id__lt=3).dates('pub_date','month') # 年-月
<QuerySet [datetime.date(1980, 5, 1), datetime.date(1986, 7, 1)]>
>>> BookInfo.objects.filter(id__lt=3).dates('pub_date','week')
<QuerySet [datetime.date(1980, 4, 28), datetime.date(1986, 7, 21)]>
>>> BookInfo.objects.filter(id__lt=3).dates('pub_date','day')   # 年-月-日
<QuerySet [datetime.date(1980, 5, 1), datetime.date(1986, 7, 24)]>
>>> BookInfo.objects.filter(id__lt=3).dates('pub_date','day',order='DESC') # 按日倒叙
<QuerySet [datetime.date(1986, 7, 24), datetime.date(1980, 5, 1)]>
```

## datetimes()

值是一个 datetime.datetime 对象的列表

## all()

返回当前 QuerySet 或 QuerySet 子类的副本

```python
>>> BookInfo.objects.all()
<QuerySet [<BookInfo: 笑傲江湖>, <BookInfo: 雪山飞狐>, <BookInfo: 天龙八部>, <BookInfo: 射雕英雄传>]>
```

## union()

使用 SQL 的 UNION 操作符来组合两个或多个 QuerySet 的结果









