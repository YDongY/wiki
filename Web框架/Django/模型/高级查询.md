---
title: 高级查询
description: 
published: true
date: 2021-02-27T03:35:03.390Z
tags: django
editor: markdown
dateCreated: 2021-02-25T16:05:13.087Z
---

# 聚合查询

## aggregate()

```python
from django.db.models import Sum, Count, Max, Min, Avg

### Avg()
>>> Book.objects.all().aggregate(Avg('price'))
{'price__avg': 34.35}

### Max()
>>> Book.objects.all().aggregate(Max('price'))
{'price__max': Decimal('81.20')}

### Min()
>>> Book.objects.all().aggregate(Min('price'))
{'price__min': Decimal('12.99')}

### Count()
>>> Book.objects.all().aggregate(Count('id'))
{'id__count': 5}

### Sum()
>>> Book.objects.aggregate(Sum('bread'))
{'bread__sum': 126}
```

`aggregate()` 函数返回值为一个字典，默认字典的键是根据字段名和聚合函数而自动生成的（字段名_聚合函数）也可以指定的名称。

```python
>>> Book.objects.aggregate(average_price=Avg('price'))
{'average_price': 34.35}
```

如果你想生成更多的聚合内容，你需要在 aggregate() 子句中加入其它参数即可

```python
>>> Book.objects.aggregate(Avg('price'), Max('price'), Min('price'))
{'price__avg': 34.35, 'price__max': Decimal('81.20'), 'price__min': Decimal('12.99')}
```

## annotate()

使用 `annotate()` 子句时 QuerySet 中的每一个对象将对指定值进行汇总。

```python
>>> q = Book.objects.annotate(Count('authors'))
>>> q[0].authors__count
2
>>> q[1].authors__count
1
```

与 aggregate() 一样，注解的名称是根据聚合函数和被聚合的字段名自动生成的，也可以重写这个默认名。

```python
>>> q = Book.objects.annotate(num_authors=Count('authors'))
>>> q[0].num_authors
2
>>> q[1].num_authors
1
```

> 与 `aggregate()` 不同的是，`annotate()` 不是终端子句。`annotate()` 子句的输出就是 QuerySet。这个 QuerySet 被其他 QuerySet 操作进行修改，包括 `filter()`, `order_by()`
{.is-info}



