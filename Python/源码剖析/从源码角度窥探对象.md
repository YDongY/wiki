---
title: 02 从源码角度窥探对象
description: 
published: true
date: 2021-03-06T15:41:48.608Z
tags: python, 源码
editor: markdown
dateCreated: 2021-03-06T15:40:23.204Z
---

由于 Python 是由 C 语言实现的，在 Python 中，对象就是 C 中的结构体在堆上申请的一块内存。一般来说对象不能被静态初始化，并且不能在栈空间上生存。唯一例外的就是类型对象，Python 中所有的内建类型对象（如整数对象、字符串对象）都是被静态初始化的。

# PyObject，对象的核心

在 Python 中，所有的东西都是对象，而所有的对象都拥有一些相同的内容，这些内容在 PyObject 结构体中定义，位于头文件 `object.h` ，路径为 `Include/object.h` ，代码如下：

```c
typedef struct _object {
    _PyObject_HEAD_EXTRA
    Py_ssize_t ob_refcnt;
    struct _typeobject *ob_type;
} PyObject;
```

除了 `_PyObject_HEAD_EXTRA` 宏，结构体包含以下两个字段：

- 引用计数 ( ob_refcnt )
- 类型指针 ( ob_type )

**引用计数**很好理解：对象被其他地方引用时加一，引用解除时减一。当引用计数为零，便可将对象回收，这是最简单的垃圾回收机制。**类型指针**指向对象类型的类型对象，类型对象描述实例对象的数据及行为（稍后详细解释）。

回过头来看 `_PyObject_HEAD_EXTRA` 宏的定义，同样在 `Include/object.h` 头文件内：

```c
#ifdef Py_TRACE_REFS
/* Define pointers to support a doubly-linked list of all live heap objects. */
#define _PyObject_HEAD_EXTRA            \
    struct _object *_ob_next;           \
    struct _object *_ob_prev;

#define _PyObject_EXTRA_INIT 0, 0,

#else
#define _PyObject_HEAD_EXTRA
#define _PyObject_EXTRA_INIT
#endif
```

通过条件编译，如果 Py_TRACE_REFS 有定义，宏展开为两个指针，看名字是用来实现双向链表的：

```c
struct _object *_ob_next;
struct _object *_ob_prev;
```

结合注释，双向链表用于跟踪所有活跃堆对象，一般不启用。

综上所说，在 PyObject 中定义了每一个 Python 对象都必须有的内容。这些内容将出现在每一个 Python 对象所占有的内存的最开始字节处。

但是在 Python 中存在很多对象，有整数对象、浮点数对象、字符串对象、列表对象等等。这些对象又分为定长和变长。不同类型的的对象，其内部除了 PyObject 之外还需要一些扩展信息。例如下面的浮点类型对象，源文件位于：`Include/floatobject.h`

```c
// Inlcude/object.h
#define PyObject_HEAD                   PyObject ob_base;

// Inlcude/floatobject.h
typedef struct {
    PyObject_HEAD
    double ob_fval;
} PyFloatObject;
```

- `PyObject_HEAD`：就是一个 PyObject
- `ob_fval`：一个 double 类型变量，记录值信息

对于变长对象，需要在 PyObject 基础上加入长度信息，这就是 `PyVarObject` ，源文件位于 `Inlcude/object.h`，代码如下：

```c
typedef struct {
    PyObject ob_base;
    Py_ssize_t ob_size; /* Number of items in variable part */
} PyVarObject;
```

- `ob_size`：指名变长对象中一共容纳了多少个元素。比如 Python 中的 list，它就是一个 `PyVarObject`，如果某一时刻，这个 list 中有 5 个元素，那么 ob_size 的值就是 5。





